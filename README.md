# üåã Seismology. ETL-–∫–æ–Ω–≤–µ–π–µ—Ä.


## üìã –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

–î–∞–Ω–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π ETL-–∫–æ–Ω–≤–µ–π–µ—Ä(—Ö–æ—Ç—è –Ω–µ–º–Ω–æ–≥–æ ELT –ø–æ–ª—É—á–∏–ª–æ—Å—å) –¥–ª—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–≥–æ —Å–±–æ—Ä–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–µ–π—Å–º–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

–û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏—è—Ö –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏, –ø—Ä–∏–≥–æ–¥–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏. –ö–æ–Ω–≤–µ–π–µ—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å –∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å.  

## üõ†Ô∏è –°—Ç–µ–∫

–ö–æ–Ω–≤–µ–π–µ—Ä –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –±–∞–∑–µ Apache Airflow —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ø–æ–¥—Ö–æ–¥–∞ Data Lake (MinIO) –∏ —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω–æ–≥–æ DWH (PostgreSQL) –¥–ª—è —Å–ª–æ–µ–≤ ODS –∏ DM.  
| **–ö–∞—Ç–µ–≥–æ—Ä–∏—è** | **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è** | **–í–µ—Ä—Å–∏—è** |
| ----- | ----- | ----- |
| –û—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏—è | Apache Airflow | 2.10.5 |
| –•—Ä–∞–Ω–∏–ª–∏—â–µ RAW | MinIO S3 | RELEASE.2025-02-18T16-25-55Z |
| –•—Ä–∞–Ω–∏–ª–∏—â–µ DWH | PostgreSQL | 13 |
| Data Mover | ClickHouse | 24.3.6 |
| –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è | Power BI | desktop |

## ‚öôÔ∏è –ò–Ω–∂–µ–Ω–µ—Ä–Ω—ã–µ –ø—Ä–∞–∫—Ç–∏–∫–∏
 
–ü—Ä–æ–µ–∫—Ç –æ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª –¥–∞—Ç–∞-–∏–Ω–∂–∏–Ω–∏—Ä–∏–Ω–≥–∞: –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–æ –≤–∏—Ç—Ä–∏–Ω –¥–∞–Ω–Ω—ã—Ö.
 
1. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ DevOps:**
 
    * –Ø–≤–Ω–æ–µ –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ.
        
    * –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å —Å—Ä–µ–¥—ã(Docker-—Åompose –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Airflow, PostgreSQL, MinIO –∏ ClickHouse).
     
    * –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç–¥–µ–ª–µ–Ω–∞ –æ—Ç –∫–æ–¥–∞.
  
    * –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.
   
    * –°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ—Å—Ç—å:
    ```bash

    concurrency=1,
    
    max_active_tasks=1,
    
    max_active_runs=1,
    
    ```
    * –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è Airflow Connections: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è postgres_dwh –∏ clickhouse_default.
    
    * –ö–ª—é—á–∏ Airflow: –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–∏ –æ—Ç Minio
 
2. **RAW -> ODS:**
 
    * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ ClickHouse –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.
    
    * –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—ã—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ Parquet-—Ñ–æ—Ä–º–∞—Ç–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LZ4-—Å–∂–∞—Ç–∏—è.
 
    * –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è (ODS-—Å–ª–æ–π).
```bash
CREATE_TABLE_SQL = f"""
CREATE TABLE IF NOT EXISTS {SCHEMA}.{TABLE_NAME} (
    time date,
    depth float8,
    mag_type varchar,
    nst smallint
)
"""
```
3. **–ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:**
 
    * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∞–∫—Ä–æ—Å–æ–≤ Airflow ({{ ds }}) –≤ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞—Ö SQL –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–æ–≥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –¥–Ω—è, –∏–∑–æ–ª–∏—Ä—É—è –µ–≥–æ –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–∞—Ä—Ç–∏—Ü–∏–π.
 
    * –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ ON CONFLICT (PRIMARY KEY) DO UPDATE SET –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø–∏—Å–µ–π –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞—Ö DAG.
    
    * –ò –∫–æ–Ω–µ—á–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏ DAG-–æ–≤ —Å –ø–æ–º–æ—â—å—é ExternalTaskSensor.
 
4. **–ê–≥—Ä–µ–≥–∞—Ü–∏—è –∏ –≤–∏—Ç—Ä–∏–Ω—ã –¥–∞–Ω–Ω—ã—Ö**
 
    * –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –≤–∏—Ç—Ä–∏–Ω —Å –∞–≥—Ä–µ–≥–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–∞–±–æ—Ç—ã –≤ BI-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ö.

–¢—Ä–µ–±—É–µ–º—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è Airflow Connections
